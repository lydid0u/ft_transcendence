<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ma SPA - Tutoriel</title>
        <!-- <script src="https://cdn.tailwindcss.com"></script> -->
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <meta name="google-signin-client_id" content="632484486903-vm1hfg66enqfkffsmlhih0au506obuch.apps.googleusercontent.com">
        <link href="styles.css?v=1.0" rel="stylesheet">
</head>
<body>
    <nav>
        <div class="nav-container">
            <img src="logo.png" href="/" class="logo" data-route="/">
            <ul class="nav-links">
                <li><a href="/home" data-route="/home">Accueil</a></li>
                <li><a href="/about" data-route="/about">√Ä propos</a></li>
                <li><a href="/dashboard" data-route="/dashboard">dashboard</a></li>
                <li><a href="/tournoi" data-route="/tournoi">tournoi</a></li>
            </ul>
        </div>
    </nav>

    <main id="content"> </main>

    <script>
      // config de la SPA, a chaque clique sur un lien, au lieu de rechgarger la page on charge juste le contenu de la div #content
      // et on change l'url avec l'API History pour pouvoir faire precedent/suivant
        const SPA = {
            SPAattribute: {
                defaultRoute: '/', //page par d√©faut
                contentDiv: '#content' //id de l'html o√π le contenu sera charg√©
            },

            // cache pour stocker les pages d√©j√† charg√©es et eviter de les recharger
            cache: new Map(),

            // Fonction pour masquer la navigation et adapter le layout pour la landing page
            hideStyleForLandingPage: function() {
                document.querySelector('nav').style.display = 'none';
                const main = document.querySelector('main');
                main.style.margin = '0';
                main.style.maxWidth = 'none';
                main.style.background = 'transparent';
                main.style.boxShadow = 'none';
                main.style.borderRadius = '0';
                main.style.minHeight = '100vh';
                main.style.padding = '0';
            },

            // Fonction pour restaurer la navigation et le layout normal
            mainDivCSS: function() {
                document.querySelector('nav').style.display = 'block';
                const main = document.querySelector('main');
                main.style.margin = '2rem auto';
                main.style.maxWidth = '1200px';
                main.style.background = 'white';
                main.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                main.style.borderRadius = '8px';
                main.style.minHeight = '500px';
                main.style.padding = '0 2rem';
            },

            // Fonction pour afficher la transition VHS
            showVhsTransition: function() {
                const app = document.querySelector('#content');
                app.innerHTML = `
                    <div class="vhs-transition">
                        <img src="gif/vhs.gif" class="vhs-gif" alt="Transition VHS">
                    </div>
                `;
                
                // Apr√®s 3 secondes (ajustez selon la dur√©e de votre GIF), rediriger vers /home
                setTimeout(() => {
                    this.navigateTo('/home');
                }, 2000);
            },

            routes: {
                '/': {
                    title: 'ft_transcendence',
                    content: `
                        <div class="landing-container">
                            <div class="landing-content">
                                <h1 class="landing-title">FT_TRANSCENDENCE</h1>
                                <button class="enter-button" onclick="SPA.showVhsTransition()">
                                    Entrer
                                </button>
                            </div>
                        </div>
                    `,
                    routeScript: function() {
                        SPA.hideStyleForLandingPage();
                        console.log('üé¨ Landing page avec tv.gif charg√©e');
                    }
                },

                '/home': {
                    title: 'Accueil',
                    content: `
                        <div class="page-content">
                            <h1>HOME</h1>

                            <!-- Contenu principal de la page home -->
                            <div style="margin-top: 2rem;">
                                <h2>Bienvenue sur ft_transcendence</h2>
                                <button class="btn" onclick="SPA.navigateTo('/login')">Se connecter</button>
                            </div>
                        </div>
                    `,
                    routeScript: function() {
                        SPA.mainDivCSS();
                    }
                },    
                       
                '/about': {
                    title: 'Qui sommes-nous ?',
                    content: `
                        <div class="page-content">
                            <h1>√Ä propos</h1>
                            <p>Lydia et khalid bang bang</p>
                        </div>
                    `,
                    routeScript: function() {
                        SPA.mainDivCSS();
                        console.log('Page √Ä propos charg√©e !');
                    }
                },

                '/tournoi': {
                    title: 'tournoi',
                    content: `
                        <div class="page-content">
                            <h1> tournoi</h1>
                        </div>
                    `,
                    routeScript: function() {
                        SPA.mainDivCSS();
                    }
                },

                '/dashboard': {
                    title: 'dashboard',
                    content: `
                        <div class="page-content">
                            <h1>dashboard</h1>
                        </div>
                    `,
                    routeScript: function() {
                        SPA.mainDivCSS();
                    }
                },

                '/login': {
                    title: 'login',
                    content: `
                        <div class="page-content">
                            <h1>login</h1>
                             <!-- Section d'authentification Google -->
                            <div id="auth-section" style="margin: 2rem 0; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;">
                                <h2>Authentification Google</h2>
                                
                                <!-- Bouton de connexion (affich√© quand non connect√©) -->
                                <div id="signin-section" style="display: block;">
                                    <p>Connectez-vous avec votre compte Google :</p>
                                    <div id="g_id_onload"
                                         data-client_id="632484486903-vm1hfg66enqfkffsmlhih0au506obuch.apps.googleusercontent.com"
                                         data-callback="handleGoogleAuth"
                                         data-auto_prompt="false">
                                    </div>
                                    <div class="g_id_signin"
                                         data-type="standard"
                                         data-size="large"
                                         data-theme="outline"
                                         data-text="sign_in_with"
                                         data-shape="rectangular"
                                         data-logo_alignment="left">
                                    </div>
                                </div>
                                <div id=loginWithAccountSection style="display: none;">
                                    <p>Ou connectez-vous avec votre compte :</p>
                                    <form id="login-form" style="display: flex; flex-direction: column; gap: 1rem;">
                                        <input type="email" id="email" placeholder="Email" required style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
                                        <input type="password" id="password" placeholder="Mot de passe" required style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
                                        <button type="submit" class="btn" style="background: #007bff; color: white;">Se connecter</button>
                                        </form>
                                        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">Pas de compte ? <a href="/register" data-route="/register" style="color: #007bff;">Inscrivez-vous</a></p>
                                </div>
                                            
                                <!-- Section utilisateur connect√© (masqu√©e par d√©faut) -->
                                <div id="user-section" style="display: none;">
                                    <div id="user-info" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                        <img id="user-photo" src="" alt="Photo de profil" style="width: 50px; height: 50px; border-radius: 50%;">
                                        <div>
                                            <h3 id="user-name"></h3>
                                            <p id="user-email" style="color: #666; font-size: 0.9rem;"></p>
                                        </div>
                                    </div>
                                    <button id="signout-btn" class="btn" style="background: #dc3545; margin-top: 1rem;">
                                        Se d√©connecter
                                    </button>
                                </div>
                            </div>
                        </div>
                    `,
                    routeScript: function() {
                        SPA.mainDivCSS();

                         // Initialiser l'authentification Google
                         if (typeof google !== 'undefined' && google.accounts) {
                            google.accounts.id.initialize({
                                client_id: "632484486903-vm1hfg66enqfkffsmlhih0au506obuch.apps.googleusercontent.com",
                                callback: handleGoogleAuth
                            });
                            
                            // Rendre le bouton de connexion
                            google.accounts.id.renderButton(
                                document.querySelector('.g_id_signin'),
                                { 
                                    theme: "outline", 
                                    size: "large",
                                    text: "sign_in_with",
                                    shape: "rounded",
                                    logo_alignment: "left"
                                }
                            );
                        }
                        
                        // V√©rifier si l'utilisateur est d√©j√† connect√©
                        const savedUser = localStorage.getItem('googleUser');
                        if (savedUser) {
                            const userData = JSON.parse(savedUser);
                            displayUserInfo(userData);
                        }
                        
                        // G√©rer la d√©connexion
                        const signoutBtn = document.getElementById('signout-btn');
                        if (signoutBtn) {
                            signoutBtn.addEventListener('click', signOut);
                        }
                    }
                }
            },

            //cette fonction demarre la SPA, elle est appel√©e quand le DOM est charg√© et charge la 1e page
            initSPA: function() {
                console.log('üöÄ Initialisation de la SPA...');
                
                this.handleClick();
                this.handlePreviousNextButtons();
                this.loadCurrentPage();
                
                console.log('‚úÖ SPA initialis√©e avec succ√®s !');
            },

            //gere les clics sur les liens de navigation et empeche le rechargement de la page
            handleClick: function() {
              document.addEventListener('click', (e) => {
                  
                    const link = e.target.closest('[data-route]'); // on recup l'element clique avec e.target et .closest cherche dans le DOM l'element le plus proche qui a l'attribut 'data-route'
                    //si ca a ete trouve, on stop le comportement par defaut (rechargement de la page) et on change l'url et le contenu sur la page sans recharger la page
                    if (link) {
                        e.preventDefault();
                        const route = link.getAttribute('data-route');
                        this.navigateTo(route);
                    }
                });
            },

            handlePreviousNextButtons: function() {
                window.addEventListener('popstate', () => { //popstate est un evenement web qui sactive apres qu'on ai clique suivant/precedent et previent du changement d'url
                    this.loadCurrentPage(); //cette fonction est alors appelee pour charger la page correspondante a l'url actuelle
                });
            },

            navigateTo: function(route) {
              // fonction membre qui vient de l'API History et qui change l'url sans recharger la page
                history.pushState(null, null, route);
                
                this.loadRoute(route);
                
                this.setCurrentPageToActive(route);
            },

            loadRoute: function(route) {
                console.log(`üìÑ Chargement de la route: ${route}`);
                
                const routeToLoad = this.routes[route];
                if (!routeToLoad) {
                    console.error(`‚ùå Route non trouv√©e: ${route}`);
                    this.error404();
                    return;
                }

                document.title = routeToLoad.title;

                const contentDiv = document.querySelector(this.SPAattribute.contentDiv);
                contentDiv.innerHTML = routeToLoad.content;

                // rend fluide le changement de page
                contentDiv.classList.remove('fade-in');
                contentDiv.offsetHeight;
                contentDiv.classList.add('fade-in');

                // on attend 1ms que le DOM charge avant de lancer le script specifiquie a la page 
                if (routeToLoad.routeScript && typeof routeToLoad.routeScript === 'function') {
                    setTimeout(() => {
                        routeToLoad.routeScript();
                    }, 10);
                }
            },

            loadCurrentPage: function() {
                const currentPath = window.location.pathname;
                this.loadRoute(currentPath);
                this.setCurrentPageToActive(currentPath);
            },

            // supprime le css active de l'ancienne page et ajoute le nouveau css
            setCurrentPageToActiveupdateActivePage: function(currentRoute) {
                document.querySelectorAll('.nav-links a').forEach(link => {
                    link.classList.remove('active');
                });

                const activeLink = document.querySelector(`[data-route="${currentRoute}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
            },

            error404: function() {
                const contentDiv = document.querySelector(this.SPAattribute.contentDiv);
                contentDiv.innerHTML = `
                    </div>
                    <div class="vhs-transition">
                        <img src="gif/error404.gif" class="vhs-gif" alt="Transition VHS">

                `;
                document.title = 'Error 404';
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            SPA.initSPA();
        });

        function handleGoogleAuth(response) {
            console.log("Encoded JWT ID token: " + response.credential);
            
            // on decode le token jwt pour obtenir les info du user
            const objUserData = decodeJwtResponse(response.credential);
            
            const userData = {
                googleId: objUserData.sub,
                name: objUserData.name,
                email: objUserData.email,
                picture: objUserData.picture,
                token: response.credential
            };
            sendUserDataToBackend(userData);
        }

        async function sendUserDataToBackend(userData) {
            try {
                    const response = await fetch('http://localhost:3000/auth/google', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                // on recupere la reponse du backend, 
                const result = await response.json();
                console.log("R√©ponse du backend:", result);

                // save dans localStorage pour la session locale
                localStorage.setItem('googleUser', JSON.stringify(userData));
                localStorage.setItem('isAuthenticated', 'true');
                
                displayUserInfo(userData);
            } catch (error) {
                console.error("Erreur lors de l'envoi au backend:", error);
                
                localStorage.removeItem('googleUser');
                localStorage.removeItem('isAuthenticated');

                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.disableAutoSelect();
                }
                
                SPA.navigateTo('/login');
                
                alert('Erreur de connexion au serveur. Veuillez r√©essayer.');
            }
        }

        // on prend le payload ,base64Url en base64 en json, puis on return le json en objet js
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            return JSON.parse(jsonPayload);
        }

        function displayUserInfo(userData) {
            // cache le boutton de connexion
            const signinSection = document.getElementById('signin-section');
            if (signinSection) {
                signinSection.style.display = 'none';
            }
            
            // Afficher la section utilisateur
            const userSection = document.getElementById('user-section');
            if (userSection) {
                userSection.style.display = 'block';

                const userPhoto = document.getElementById('user-photo');
                const userName = document.getElementById('user-name');
                const userEmail = document.getElementById('user-email');
                
                if (userPhoto) userPhoto.src = userData.picture;
                if (userName) userName.textContent = userData.name;
                if (userEmail) userEmail.textContent = userData.email;
            }
        }

        function signOut() {
            localStorage.removeItem('googleUser');
            
            // supprime le token google
            if (typeof google !== 'undefined' && google.accounts)
                google.accounts.id.disableAutoSelect();
            
            // cache la section info utilisateur
            const userSection = document.getElementById('user-section');
            if (userSection) {
                userSection.style.display = 'none';
            }
            
            // affiche le bouton de connexion
            const signinSection = document.getElementById('signin-section');
            if (signinSection)
                signinSection.style.display = 'block';
            
            console.log('Utilisateur d√©connect√©');
        }
    </script>
</body>
</html>
